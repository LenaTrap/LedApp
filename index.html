<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ESP32 9x9 LED Controller</title>

<style>
body {
  font-family: Arial;
  text-align: center;
  background: #111;
  color: white;
}

#grid {
  display: grid;
  grid-template-columns: repeat(9, 40px);
  gap: 4px;
  justify-content: center;
  margin-top: 20px;
}

.pixel {
  width: 40px;
  height: 40px;
  background: black;
  border: 1px solid #333;
  cursor: pointer;
}

button {
  margin: 10px;
  padding: 10px 20px;
  font-size: 16px;
}
</style>
</head>

<body>

<h2>ESP32 9x9 LED Controller</h2>

<input type="color" id="colorPicker" value="#ff0000">

<br>

<button onclick="connect()">Connect</button>
<button onclick="sendData()">Send to ESP32</button>

<div id="grid"></div>

<script>

const SERVICE_UUID = "12345678-1234-1234-1234-1234567890ab";
const CHARACTERISTIC_UUID = "abcd1234-5678-90ab-cdef-1234567890ab";

let device;
let characteristic;

const NUM_LEDS = 81;
let ledColors = new Array(NUM_LEDS).fill({r:0,g:0,b:0});

const grid = document.getElementById("grid");

// Create 9x9 grid
for (let i = 0; i < NUM_LEDS; i++) {
  const div = document.createElement("div");
  div.className = "pixel";
  div.dataset.index = i;

  div.addEventListener("click", () => {
    const color = document.getElementById("colorPicker").value;
    div.style.background = color;

    const rgb = hexToRgb(color);
    ledColors[i] = rgb;
  });

  grid.appendChild(div);
}

function hexToRgb(hex) {
  const bigint = parseInt(hex.slice(1), 16);
  return {
    r: (bigint >> 16) & 255,
    g: (bigint >> 8) & 255,
    b: bigint & 255
  };
}

async function connect() {
  device = await navigator.bluetooth.requestDevice({
    filters: [{ name: "ESP32_LED_81" }],
    optionalServices: [SERVICE_UUID]
  });

  const server = await device.gatt.connect();
  const service = await server.getPrimaryService(SERVICE_UUID);
  characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);

  alert("Connected!");
}

async function sendData() {
  if (!characteristic) {
    alert("Not connected!");
    return;
  }

  const data = new Uint8Array(NUM_LEDS * 3);

  for (let i = 0; i < NUM_LEDS; i++) {
    data[i * 3]     = ledColors[i].r;
    data[i * 3 + 1] = ledColors[i].g;
    data[i * 3 + 2] = ledColors[i].b;
  }

  await characteristic.writeValue(data);
}

</script>

</body>
</html>
